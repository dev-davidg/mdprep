<!DOCTYPE html>
<html lang="sk">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap">
<title>MDprep – Test</title>

<!-- Shared styles -->
<link rel="stylesheet" href="/stitch/styles.v2.css?v=60"/>
<link rel="stylesheet" href="/stitch/theme.css?v=60"/>
<link rel="stylesheet" href="/stitch/pro.css?v=2"/>

<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

<style>
  /* v60: lock width to 56rem on desktop and stabilize layout */
  @media (min-width:1024px){
    body.mx-page main{max-width:56rem!important;margin-left:auto!important;margin-right:auto!important}
    body.mx-page header > *, body.mx-page header :is(div,nav){max-width:56rem!important;margin-left:auto!important;margin-right:auto!important}
  }
  html{ scrollbar-gutter: stable both-edges; }
  body{ min-height:max(884px,100dvh); }

  /* Answer button states (do NOT reveal correctness) */
  .answer-btn{ transition: border-color .18s ease, background-color .18s ease, box-shadow .18s ease, transform .08s ease; }
  .answer-btn:hover{ transform: translateY(-1px); }
  .answer-selected{ border-color:#2563eb !important; background:#eff6ff !important; } /* blue-600 border, blue-50 bg */
  .answer-disabled{ opacity:.8; pointer-events:none; }

  /* Navigator chips */
  .qchip{ transition: transform .1s ease, box-shadow .18s ease, background-color .18s ease, border-color .18s ease; }
  .qchip:hover{ transform: translateY(-1px); }
  .qchip-current{ border-color:#2563eb !important; }
  .qchip-answered{ background:#eff6ff !important; border-color:#2563eb !important; color:#1e40af !important; }

  /* Hide scrollbar track in the horizontal chip scroller (keeps scroll) */
  .no-scrollbar::-webkit-scrollbar{ display:none; }
  .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
</style>
</head>
<body class="bg-gray-50 text-gray-900 mx-page">
<div class="relative min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-white shadow-sm sticky top-0 z-10">
    <div class="mx-auto max-w-4xl p-4 pb-3 flex items-center justify-between">
      <h1 class="text-xl font-bold leading-tight tracking-tight">Test</h1>
      <div class="flex items-center gap-2">
        <span class="text-xs text-gray-600 hidden sm:inline">Čas na otázku</span>
        <span id="timer" class="badge badge-blue">01:30</span>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-4xl w-full p-4 space-y-6 page-fade">
    <!-- Top meta + question navigator -->
    <section class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
      <div class="flex items-center justify-between gap-4">
        <div class="text-sm text-gray-700">
          <span class="font-semibold">Otázka</span> <span id="qIndex">1</span>/<span id="qTotal">10</span>
        </div>
        <button id="flagBtn" class="rounded-full border border-gray-200 bg-blue-50 text-blue-700 text-xs font-bold px-3 py-1.5 hover:bg-blue-100">
          Označiť
        </button>
      </div>

      <!-- Horizontal scroll question navigator -->
      <div id="qNav" class="mt-3 overflow-x-auto no-scrollbar">
        <div id="qNavInner" class="flex items-center gap-2 min-w-max"></div>
      </div>
    </section>

    <!-- Question card -->
    <section class="rounded-2xl border border-gray-200 bg-white shadow-sm p-4">
      <h2 id="qText" class="text-base font-bold text-gray-900">Ktorá štruktúra je zodpovedná za produkciu inzulínu?</h2>

      <div class="mt-4 grid grid-cols-1 gap-2">
        <!-- NO correctness reveal in Test; selection only marks chosen -->
        <button class="answer-btn rounded-xl border border-gray-200 bg-white text-left px-4 py-3" data-answer="A">A) Hypofýza</button>
        <button class="answer-btn rounded-xl border border-gray-200 bg-white text-left px-4 py-3" data-answer="B">B) Pankreas (Langerhansove ostrovčeky)</button>
        <button class="answer-btn rounded-xl border border-gray-200 bg-white text-left px-4 py-3" data-answer="C">C) Pečeň</button>
        <button class="answer-btn rounded-xl border border-gray-200 bg-white text-left px-4 py-3" data-answer="D">D) Štítna žľaza</button>
      </div>

      <!-- Actions -->
      <div class="mt-4 flex flex-wrap items-center justify-between gap-3">
        <button id="prevBtn" class="rounded-full bg-blue-50 text-blue-700 text-sm font-bold px-5 py-2 hover:bg-blue-100">Predošlá</button>
        <div class="flex items-center gap-3">
          <button id="skipBtn" class="rounded-full bg-blue-50 text-blue-700 text-sm font-bold px-5 py-2 hover:bg-blue-100">Preskočiť</button>
          <button id="nextBtn" class="rounded-full bg-blue-500 text-white text-sm font-bold px-5 py-2 hover:bg-blue-600">Ďalej</button>
          <button id="finishBtn" disabled class="rounded-full bg-blue-500/60 text-white text-sm font-bold px-5 py-2 cursor-not-allowed">Ukončiť test</button>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- Unified bottom nav -->
<script src="/stitch/common-nav.v3.js?v=60"></script>

<script>
(function(){
  // --- Preferences ---
  const PREF_KEY = 'mdprep_prefs';
  const prefs = (()=>{ try { return JSON.parse(localStorage.getItem(PREF_KEY)||'{}'); } catch { return {}; } })();
  const autoAdvance = !!prefs.autoAdvance; // user may enable "go next after selection" in settings

  // --- Elements ---
  const qIndexEl = document.getElementById('qIndex');
  const qTotalEl = document.getElementById('qTotal');
  const qNavInner = document.getElementById('qNavInner');
  const qText = document.getElementById('qText');
  const answers = Array.from(document.querySelectorAll('.answer-btn'));
  const flagBtn = document.getElementById('flagBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const skipBtn = document.getElementById('skipBtn');
  const finishBtn = document.getElementById('finishBtn');
  const timerEl = document.getElementById('timer');

  // --- State (Stitch mock) ---
  const params = new URLSearchParams(location.search);
  const TOTAL = Math.max(1, Number(params.get('count')||'10'));
  let idx = Math.max(1, Math.min(TOTAL, Number(params.get('q')||'1')));
  let flags = new Set(JSON.parse(localStorage.getItem('md_test_flags')||'[]'));
  let answersMap = JSON.parse(localStorage.getItem('md_test_answers')||'{}'); // { "1":"B", "2":"C", ... }
  let perQuestionTime = 90; // seconds
  let remaining = perQuestionTime;
  let tHandle = null;

  qTotalEl.textContent = String(TOTAL);

  // --- Build navigator chips ---
  function buildNav(){
    qNavInner.innerHTML = '';
    for (let i=1;i<=TOTAL;i++){
      const a = !!answersMap[i];
      const chip = document.createElement('button');
      chip.type = 'button';
      chip.className = 'qchip rounded-full border border-gray-200 bg-white text-sm font-bold px-3 py-1.5';
      if (i === idx) chip.classList.add('qchip-current');
      if (a) chip.classList.add('qchip-answered');
      chip.textContent = i;
      chip.setAttribute('aria-label', 'Otázka ' + i + (a ? ' — zodpovedané' : ' — nezodpovedané'));
      chip.addEventListener('click', ()=> goto(i));
      qNavInner.appendChild(chip);
    }
  }

  // --- Render current index + selection state ---
  function render(){
    qIndexEl.textContent = String(idx);

    // Reset answer visuals
    answers.forEach(b => b.classList.remove('answer-selected','answer-disabled'));
    const chosen = answersMap[idx];
    if (chosen){
      const btn = answers.find(b => b.dataset.answer === chosen);
      if (btn) btn.classList.add('answer-selected');
    }

    // Buttons state
    prevBtn.disabled = (idx === 1);
    prevBtn.className = prevBtn.disabled
      ? 'rounded-full bg-blue-50 text-blue-700/60 text-sm font-bold px-5 py-2 cursor-not-allowed'
      : 'rounded-full bg-blue-50 text-blue-700 text-sm font-bold px-5 py-2 hover:bg-blue-100';

    // Finish enabled only when all answered
    const answeredCount = Object.keys(answersMap).length;
    const allAnswered = answeredCount >= TOTAL;
    finishBtn.disabled = !allAnswered;
    finishBtn.className = allAnswered
      ? 'rounded-full bg-blue-500 text-white text-sm font-bold px-5 py-2 hover:bg-blue-600'
      : 'rounded-full bg-blue-500/60 text-white text-sm font-bold px-5 py-2 cursor-not-allowed';

    // Flag visual
    const flagged = flags.has(idx);
    flagBtn.classList.toggle('bg-amber-50', flagged);
    flagBtn.classList.toggle('text-amber-700', flagged);
    flagBtn.classList.toggle('border-amber-300', flagged);
    flagBtn.textContent = flagged ? 'Označené' : 'Označiť';

    // Navigator chips
    buildNav();

    // Restart timer for this question
    startTimer();
  }

  // --- Timer (90s per question) ---
  function startTimer(){
    stopTimer();
    remaining = perQuestionTime;
    updateTimer();
    tHandle = setInterval(()=>{
      remaining--;
      if (remaining <= 0){
        stopTimer();
        // Time up: if no answer yet, mark skipped and go next
        if (!answersMap[idx]) {
          // store explicit skip marker (optional); leaving empty keeps it "unanswered"
          // answersMap[idx] = null;
        }
        saveState();
        goNext();
      }else{
        updateTimer();
      }
    }, 1000);
  }
  function stopTimer(){ if (tHandle) clearInterval(tHandle); tHandle = null; }
  function updateTimer(){
    const m = Math.floor(remaining/60).toString().padStart(2,'0');
    const s = (remaining%60).toString().padStart(2,'0');
    timerEl.textContent = m + ':' + s;
  }

  // --- Navigation helpers ---
  function saveState(){
    try{
      localStorage.setItem('md_test_answers', JSON.stringify(answersMap));
      localStorage.setItem('md_test_flags', JSON.stringify(Array.from(flags)));
    }catch{}
  }
  function goto(n){
    if (n === idx) return;
    idx = Math.max(1, Math.min(TOTAL, n));
    const url = new URL(location.href);
    url.searchParams.set('q', String(idx));
    history.replaceState(null, '', url.toString());
    render();
  }
  function goPrev(){ goto(idx-1); }
  function goNext(){ goto(idx+1 <= TOTAL ? idx+1 : idx); }

  // --- Wire controls ---
  prevBtn.addEventListener('click', goPrev);
  nextBtn.addEventListener('click', goNext);
  skipBtn.addEventListener('click', goNext);
  finishBtn.addEventListener('click', ()=>{
    // Only navigate if all answered (button stays disabled otherwise)
    location.href = '/stitch/results.html';
  });
  flagBtn.addEventListener('click', ()=>{
    if (flags.has(idx)) flags.delete(idx); else flags.add(idx);
    saveState(); render();
  });

  // --- Answer selection (no correctness reveal) ---
  answers.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const val = btn.dataset.answer;
      answersMap[idx] = val;
      saveState();
      render();
      if (autoAdvance) setTimeout(()=> goNext(), 250);
    });
  });

  // Init
  render();
})();
</script>
</body>
</html>
